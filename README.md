## Технологический журнал и Ansible

В репозитории представлена роль Ansible для настройки технологического журнала.

Для роли определены переменные:

- `techlog_config_path` - путь для размещения файла настроек ТЖ (полный путь с учетом имени файла `logcfg.xml`).
- `techlog` - yml представление настроек ТЖ.

Значения переменных по умолчанию определены в файле [main.yml](./roles/techlog/defaults/main.yml).

В примере [playbook'а](./playbook.yml) для хостов из групп `onec-linux`, `onec-windows` будет применена роль `techlog` с настройками ТЖ соответствующей группы - [onec-linux](./group_vars/onec-linux.yml) или [onec-windows](./group_vars/onec-windows.yml).

### Настройка архивирования логов технологического журнала

Роль позволяет настроить архивирование логов ТЖ.
Настройки архивирования зависят от операционной системы хоста.
Для применения настроек архивирования, `playbook` с ролью нужно запускать указав тег `archive`:

```
ansible-playbook -i hosts.yml playbook.yml --tags=archive
```

#### Настройки архивирования для Windows 

Для `windows` хостов требуется установленный архиватор `7-zip`, путь к каталогу архиватора должен быть добавлен в `path`.
На хосте будут выполнены следующие настройки:

- Создан каталог для хранения архивов логов технологического журнала.
- В каталог скопирован `powershell` скрипт на основе [шаблона](./roles/techlog/templates/techlog-archive.ps1.j2).
- Создана задача `techlog_archive` для планировщика заданий, которая будет запускать скрипт с расписанием: ежедневно, каждый час, начиная с 00:10. 

#### Настройки архивирования для Linux

Для `linux` хостов будут выполнены следующие настройки:

- Установлен пакет `zip`.
- Создан каталог для хранения архивов логов технологического журнала.
- В каталог скопирован `bash` скрипт на основе [шаблона](./roles/techlog/templates/techlog-archive.sh.j2).
- Созданы `systemd` [сервис](./roles/techlog/templates/techlog-archive.service.j2) и [таймер](./roles/techlog/files/techlog-archive.timer), который будет запускать сервис архивирования с расписанием: ежедневно, каждый час, начиная с 00:10.

Переменные роли связанные с настройками архивирования:

- `techlog_archive_script_path` - путь для размещения скрипта архивирования (например, для `windows`: `C:\techlog_archive\techlog-archive.ps1`, для `linux`: `/opt/techlog_archive/techlog-archive.sh`). Архивы логов всегда будут сохранятся в каталоге размещения скрипта. Этот каталог будет создан, если он отсутствует.
- `techlog_archive_dir` - путь к каталогу логов технологического журнала, данные которого будут архивироваться (например, для `windows`: `C:\tech\logs\all`, для `linux`: `/var/log/1c/all`)
